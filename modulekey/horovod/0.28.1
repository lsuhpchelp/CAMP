#%Module

# =====================================================================
# Generated by CAMP (Containerized Application Modulekey Producer)
# Developer: Jason Li (jasonli3@lsu.edu)
# Description: This template is for MPI-enabled software packages.
#              Will generate wrappers in user's /work directory.
# =====================================================================

# ---------------------------------------------------------------------
# Software specific information
# ---------------------------------------------------------------------

# Conflicts
conflict horovod python pytorch tensorflow jax

# Module information
module-whatis Distributed training framework for TensorFlow, Keras, PyTorch, and Apache MXNet.
module-version 0.28.1

# Singularity options
set SINGULARITY_IMAGE "/home/admin/singularity/horovod-0.28.1-gpu-jupyter.sif"
set SINGULARITY_BINDPATHS "/work,/project,/usr/local/packages,/ddnA,/var/scratch,"
set SINGULARITY_FLAGS "--nv"

# List of commands to overwrite
set cmds {
python python3 pip pip3
}

# Set environment varialbles


# ---------------------------------------------------------------------
# Module key setup
# ---------------------------------------------------------------------

# Set wrapper paths
puts "mkdir /work/\$USER/.modulebin/horovod/0.28.1 -p; "
prepend-path PATH /work/$env(USER)/.modulebin/horovod/0.28.1

# Combine Singularity exec command
set singularity_exec "singularity exec -B $SINGULARITY_BINDPATHS $SINGULARITY_FLAGS --pwd \$PWD $SINGULARITY_IMAGE"

# Create wrapper directory and write wrappers there
if { [ module-info mode load ] } {
    if { [ module-info shelltype csh ] } {
        foreach cmd $cmds {
            puts "echo '#\\!/bin/'`echo \$0 | sed 's|.*/||; s|.*-||'` > /work/\$USER/.modulebin/horovod/0.28.1/$cmd;"
            puts "echo '$singularity_exec $cmd $*' >> /work/\$USER/.modulebin/horovod/0.28.1/$cmd;"
            puts "chmod u+x /work/\$USER/.modulebin/horovod/0.28.1/$cmd;"
        }
        puts "rehash"
    } elseif { [ module-info shelltype sh ] } {
        foreach cmd $cmds {
            puts "echo '#!/bin/'`echo \$0 | sed 's|.*/||; s|.*-||'` > /work/\$USER/.modulebin/horovod/0.28.1/$cmd;"
            puts "echo '$singularity_exec $cmd $@' >> /work/\$USER/.modulebin/horovod/0.28.1/$cmd;"
            puts "chmod u+x /work/\$USER/.modulebin/horovod/0.28.1/$cmd;"
        }
    }
}

# Currently, wrappers will not be deleted to avoid unwanted issues.

# For "module help" and "module load"
if { [ module-info mode help ] || [ module-info mode load ] || [ module-info mode display ] } {
    puts stderr "
\[ Help information \]

1. This module only works on computing nodes (not available on head nodes). Make sure you start a job!

2. Below executables are available:
$cmds
"
}
proc ModulesHelp {} {
}
