#%Module

# =====================================================================
# Generated by CAMP (Containerized Application Modulekey Producer)
# Developer: Jason Li (jasonli3@lsu.edu)
# Description: 
#       1) This module template is tested with Environment Modules
#           >= 4.5.2. See https://github.com/cea-hpc/modules
#          May not be compatible with different module systems.
#       2) This template generates wrapper scripts in users' /work
#          directory, and works with MPI-enabled software packages.
#       3) The difference between this and default Environment Modules
#          template is using "singularity run" instead of "singularity
#          exec", which works with NGC templates.
# =====================================================================

# ---------------------------------------------------------------------
# Software specific information
# ---------------------------------------------------------------------

# Conflicts
conflict openfoam 

# Module information
module-whatis OpenFOAM is free, open source software for CFD from the OpenFOAM Foundation.
module-version v2212

# Singularity options
set SINGULARITY_IMAGE "/home/admin/singularity/openfoam-v2212-openmpi.4.1.2-pmi2.sif"
set SINGULARITY_BINDPATHS "/work,/project,/usr/local/packages,/ddnA,/var/scratch,"
set SINGULARITY_FLAGS ""

# List of commands to overwrite
set cmds {
DPMDyMFoam DPMFoam FLMAToSurface FMSToSurface FMSToVTK MPPICDyMFoam MPPICFoam MPPICInterFoam PDRFoam PDRMesh PDRblockMesh PDRsetFields SRFPimpleFoam SRFSimpleFoam XiDyMFoam XiEngineFoam XiFoam acousticFoam adiabaticFlameT adjointOptimisationFoam adjointShapeOptimizationFoam ansysToFoam applyBoundaryLayer attachMesh autoPatch blockMesh boundaryFoam boxTurb buoyantBoussinesqPimpleFoam buoyantBoussinesqSimpleFoam buoyantPbePimpleFoam buoyantPimpleFoam buoyantSimpleFoam cartesian2DMesh cartesianMesh cavitatingDyMFoam cavitatingFoam cfx4ToFoam changeDictionary checkFaMesh checkMesh checkSurfaceMesh chemFoam chemkinToFoam chtMultiRegionFoam chtMultiRegionSimpleFoam chtMultiRegionTwoPhaseEulerFoam coalChemistryFoam coldEngineFoam collapseEdges combinePatchFaces compressibleInterDyMFoam compressibleInterFilmFoam compressibleInterFoam compressibleInterIsoFoam compressibleMultiphaseInterFoam compressiblePbeTransportFoam computeMoments computeSensitivities copySurfaceParts createBaffles createBoxTurb createExternalCoupledPatchGeometry createPatch createZeroDirectory cumulativeDisplacement datToFoam decomposePar deformedGeom denseAGFoam diluteVdfTransportFoam dnsFoam driftFluxFoam dsmcFoam dsmcInitialise electrostaticFoam engineCompRatio engineFoam engineSwirl ensightToFoam equilibriumCO equilibriumFlameT explicitRhoFoam extrude2DMesh extrudeEdgesInto2DSurface extrudeMesh extrudeToRegionMesh faParkerFukushimaFoam faSavageHutterFoam faceAgglomerate financialFoam fireFoam fireToFoam flattenMesh fluent3DMeshToFoam fluentMeshToFoam foamDataToFluent foamDictionary foamFormatConvert foamHasLibrary foamHelp foamListRegions foamListTimes foamMeshToFluent foamRestoreFields foamToEnsight foamToFireMesh foamToGMV foamToStarMesh foamToSurface foamToTetDualMesh foamToVTK foamUpgradeCyclics foamyHexMesh foamyQuadMesh gambitToFoam generateBoundaryLayers generateMoments gmshToFoam gridToSTL icoFoam icoReactingMultiphaseInterFoam icoUncoupledKinematicParcelDyMFoam icoUncoupledKinematicParcelFoam ideasUnvToFoam importSurfaceAsSubset improveMeshQuality improveSymmetryPlanes insideCells interCondensatingEvaporatingFoam interFoam interIsoFoam interMixingFoam interPhaseChangeDyMFoam interPhaseChangeFoam kinematicParcelFoam kivaToFoam laplacianFoam liquidFilmFoam lumpedPointForces lumpedPointMovement lumpedPointZones magneticFoam makeFaMesh mapFields mapFieldsPar mdEquilibrationFoam mdFoam mdInitialise mergeMeshes mergeOrSplitBaffles mergeSurfacePatches meshToFPMA mhdFoam mirrorMesh mixingTransportFoam mixtureAdiabaticFlameT modifyMesh moveDynamicMesh moveEngineMesh moveMesh mshToFoam multiphaseEulerFoam multiphaseInterFoam netgenNeutralToFoam noise nonNewtonianIcoFoam objToVTK oneWayCoupledVdfTransportFoam orientFaceZone overBuoyantPimpleDyMFoam overCompressibleInterDyMFoam overInterDyMFoam overInterPhaseChangeDyMFoam overLaplacianDyMFoam overPimpleDyMFoam overPotentialFoam overRhoPimpleDyMFoam overRhoSimpleFoam overSimpleFoam pMesh particleTracks patchSummary patchesToSubsets pbeFoam pbeTransportFoam pdfPlot pimpleFoam pisoFoam plot3dToFoam polyDualMesh polydisperseBubbleFoam porousSimpleFoam postChannel postProcess potentialFoam potentialFreeSurfaceDyMFoam potentialFreeSurfaceFoam preparePar profilingSummary reactingFoam reactingHeterogenousParcelFoam reactingMultiphaseEulerFoam reactingParcelFoam reactingTwoPhaseEulerFoam reconstructPar reconstructParMesh reconstructPointDistribution redistributePar refineHexMesh refineMesh refineWallLayer refinementLevel releaseAreaMapping removeFaces removeSurfaceFacets renumberMesh rhoCentralFoam rhoPimpleAdiabaticFoam rhoPimpleFoam rhoPorousSimpleFoam rhoReactingBuoyantFoam rhoReactingFoam rhoSimpleFoam rotateMesh scalarTransportFoam scaleMesh scaleSurfaceMesh sedFoam_rbgh sedFoam_rbghMULES selectCells setAlphaField setExprBoundaryFields setExprFields setFields setSet setTurbulenceFields setsToZones shallowWaterFoam simpleCoalParcelFoam simpleFoam simpleReactingParcelFoam simpleSprayFoam singleCellMesh slopeMesh smapToFoam smoothSurfaceData snappyHexMesh snappyRefineMesh solidDisplacementFoam solidEquilibriumDisplacementFoam solidFoam sonicDyMFoam sonicFoam sonicLiquidFoam sphereSurfactantFoam splitCells splitMesh splitMeshRegions sprayDyMFoam sprayFoam star4ToFoam steadyParticleTracks stitchMesh subsetMesh subsetToPatch surfaceAdd surfaceBooleanFeatures surfaceCheck surfaceClean surfaceCoarsen surfaceConvert surfaceFeatureConvert surfaceFeatureEdges surfaceFeatureExtract surfaceFind surfaceGenerateBoundingBox surfaceHookUp surfaceInertia surfaceInflate surfaceLambdaMuSmooth surfaceMeshConvert surfaceMeshExport surfaceMeshExtract surfaceMeshImport surfaceMeshInfo surfaceOrient surfacePatch surfacePointMerge surfaceRedistributePar surfaceRefineRedGreen surfaceSplitByPatch surfaceSplitByTopology surfaceSplitNonManifolds surfaceSubset surfaceToFMS surfaceToPatch surfaceTransformPoints surfactantFoam temporalInterpolate tetMesh tetgenToFoam thermoFoam topoSet transformPoints twoLiquidMixingFoam twoPhaseEulerFoam uncoupledKinematicParcelDyMFoam uncoupledKinematicParcelFoam vdfTransportFoam viewFactorsGen vtkUnstructuredToFoam wallFunctionTable writeActiveDesignVariables writeMeshObj writeMorpherCPs zipUpMesh 

foamCheckJobs foamCleanPath foamCleanPolyMesh foamCleanTutorials foamCloneCase foamCopySettings foamCreateVideo foamEndJob foamEtcFile foamGetDict foamInstallationTest foamJob foamLog foamMonitor foamNew foamNewApp foamNewBC foamNewCase foamNewFunctionObject foamNewSource foamNewTemplate foamPrintJobs foamRunTutorials foamSearch foamSequenceVTKFiles foamSolverSweeps foamSystemCheck foamTestTutorial mpirunDebug paraFoam tools 

wclean wcleanLnIncludeAll wdep wmake wmakeCheckPwd wmakeCollect wmakeLnInclude wmakeLnIncludeAll wrmdep wrmo 
}

# Set environment varialbles


# ---------------------------------------------------------------------
# Module key setup
# ---------------------------------------------------------------------

# Combine Singularity exec command
set singularity_exec "singularity run -B $SINGULARITY_BINDPATHS $SINGULARITY_FLAGS --pwd \$PWD $SINGULARITY_IMAGE"

# Set wrapper directory
file mkdir /work/$env(USER)/.modulebin/openfoam/v2212
prepend-path PATH /work/$env(USER)/.modulebin/openfoam/v2212

# Create wrappers when the module is loaded
if { [ module-info mode load ] } {

    # If it is csh type shell
    if { [ module-info shelltype csh ] } {
    
        # Find shell header
        #puts "setenv shellheader '#\\!/bin/'`ps -p \$\$ -o comm=`;"
        #puts "if ( ! \$?prompt ) setenv shellheader `head -n1 \$0`;"
    
        # Create wrappers for each command
        foreach cmd $cmds {
            puts "echo '#\\!/bin/bash' > /work/\$USER/.modulebin/openfoam/v2212/$cmd;"
            puts "echo '$singularity_exec $cmd $@' >> /work/\$USER/.modulebin/openfoam/v2212/$cmd;"
            puts "chmod u+x /work/\$USER/.modulebin/openfoam/v2212/$cmd;"
        }
        
        # Refresh cache (only for csh type shell)
        puts "rehash;"
        
        # Unset shell header variable
        #puts "unsetenv shellheader;"
        
    # If it is sh type shell
    } elseif { [ module-info shelltype sh ] } {
    
        # Find shell header
        #puts "\[\[ -t 0 \]\] && shellheader='#!/bin/'`ps -p \$\$ -o comm=` || shellheader=`head -n1 \$0`;"
    
        # Create wrappers for each command
        foreach cmd $cmds {
            puts "echo '#!/bin/bash' > /work/\$USER/.modulebin/openfoam/v2212/$cmd;"
            puts "echo '$singularity_exec $cmd $@' >> /work/\$USER/.modulebin/openfoam/v2212/$cmd;"
            puts "chmod u+x /work/\$USER/.modulebin/openfoam/v2212/$cmd;"
        }
        
        # Unset shell header variable
        #puts "unset shellheader;"
    }
}

# Currently, wrappers will not be deleted to avoid unwanted issues.

# For "module help" and "module load"
if { [ module-info mode help ] || [ module-info mode load ] || [ module-info mode display ] } {
    puts stderr "
\[ Help information \]

1. This module only works on computing nodes (not available on head nodes). Make sure you start a job!

2. Below executables are available:
$cmds"
}
proc ModulesHelp {} {
}
